services:
  # ==========================================================================
  # Frontend - React/Vite Development Server
  # ==========================================================================
  frontend:
    build:
      context: .
      dockerfile: docker/frontend/Dockerfile
      target: development
    container_name: prolific-frontend
    ports:
      - "3000:3000"
    volumes:
      # Mount source code for hot reload
      - ./frontend/src:/app/src:cached
      - ./frontend/public:/app/public:cached
      - ./frontend/index.html:/app/index.html:cached
      - ./frontend/vite.config.ts:/app/vite.config.ts:cached
      - ./frontend/tsconfig.json:/app/tsconfig.json:cached
      - ./frontend/tsconfig.node.json:/app/tsconfig.node.json:cached
      - ./frontend/tailwind.config.js:/app/tailwind.config.js:cached
      - ./frontend/postcss.config.js:/app/postcss.config.js:cached
      - ./frontend/components.json:/app/components.json:cached
      # Prevent node_modules from being overwritten
      - frontend_node_modules:/app/node_modules
    environment:
      - NODE_ENV=development
      - VITE_API_URL=http://localhost:4001
      - CHOKIDAR_USEPOLLING=true
      - WATCHPACK_POLLING=true
    depends_on:
      backend:
        condition: service_healthy
    networks:
      - prolific-network
    restart: unless-stopped

  # ==========================================================================
  # Backend - Node.js/Express/TypeScript API
  # ==========================================================================
  backend:
    build:
      context: .
      dockerfile: docker/backend/Dockerfile
      target: development
    container_name: prolific-backend
    ports:
      - "4001:4000"
      - "9230:9229"
    volumes:
      # Mount source code for hot reload
      - ./backend/src:/app/src:cached
      - ./backend/prisma:/app/prisma:cached
      - ./backend/tsconfig.json:/app/tsconfig.json:cached
      - ./backend/package.json:/app/package.json:cached
      # Persistent uploads directory
      - ./uploads:/app/uploads
      # Prevent node_modules from being overwritten
      - backend_node_modules:/app/node_modules
    environment:
      - NODE_ENV=development
      - PORT=4000
      - DATABASE_URL=postgresql://prolific:prolific_dev_password@postgres:5432/prolific_email?schema=public
      - REDIS_URL=redis://redis:6379
      - JWT_SECRET=dev_jwt_secret_change_in_production_minimum_32_chars
      - ENCRYPTION_KEY=0123456789abcdef0123456789abcdef0123456789abcdef0123456789abcdef
      - CORS_ORIGIN=http://localhost:3000
      - LOG_LEVEL=debug
      - ASSET_STORAGE_PATH=/app/uploads
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:4000/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    networks:
      - prolific-network
    restart: unless-stopped

  # ==========================================================================
  # Worker - BullMQ Background Job Processor
  # ==========================================================================
  worker:
    build:
      context: .
      dockerfile: docker/backend/Dockerfile
      target: development
    container_name: prolific-worker
    volumes:
      - ./backend/src:/app/src:cached
      - ./backend/prisma:/app/prisma:cached
      - ./backend/tsconfig.json:/app/tsconfig.json:cached
      - ./backend/package.json:/app/package.json:cached
      - ./uploads:/app/uploads
      - backend_node_modules:/app/node_modules
    environment:
      - NODE_ENV=development
      - DATABASE_URL=postgresql://prolific:prolific_dev_password@postgres:5432/prolific_email?schema=public
      - REDIS_URL=redis://redis:6379
      - ENCRYPTION_KEY=0123456789abcdef0123456789abcdef0123456789abcdef0123456789abcdef
      - JWT_SECRET=dev_jwt_secret_change_in_production_minimum_32_chars
      - WORKER_CONCURRENCY=5
      - LOG_LEVEL=debug
    command: ["npm", "run", "dev:worker"]
    depends_on:
      backend:
        condition: service_healthy
    networks:
      - prolific-network
    restart: unless-stopped

  # ==========================================================================
  # PostgreSQL Database
  # ==========================================================================
  postgres:
    image: postgres:15-alpine
    container_name: prolific-postgres
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./docker/scripts/init-db.sql:/docker-entrypoint-initdb.d/init-db.sql:ro
    environment:
      - POSTGRES_USER=prolific
      - POSTGRES_PASSWORD=prolific_dev_password
      - POSTGRES_DB=prolific_email
      - PGDATA=/var/lib/postgresql/data/pgdata
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U prolific -d prolific_email"]
      interval: 5s
      timeout: 5s
      retries: 5
      start_period: 10s
    networks:
      - prolific-network
    restart: unless-stopped

  # ==========================================================================
  # Redis Cache & Queue
  # ==========================================================================
  redis:
    image: redis:7-alpine
    container_name: prolific-redis
    ports:
      - "6380:6379"
    volumes:
      - redis_data:/data
      - ./docker/redis/redis.conf:/usr/local/etc/redis/redis.conf:ro
    command: redis-server /usr/local/etc/redis/redis.conf
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 5s
      retries: 5
      start_period: 5s
    networks:
      - prolific-network
    restart: unless-stopped

  # ==========================================================================
  # Database Migrations & Seeding (runs once)
  # ==========================================================================
  db-migrate:
    build:
      context: .
      dockerfile: docker/backend/Dockerfile
      target: development
    container_name: prolific-db-migrate
    volumes:
      - ./backend/prisma:/app/prisma:cached
      - ./backend/src:/app/src:cached
      - backend_node_modules:/app/node_modules
    environment:
      - DATABASE_URL=postgresql://prolific:prolific_dev_password@postgres:5432/prolific_email?schema=public
    command: >
      sh -c "
        echo 'Waiting for database to be ready...' &&
        sleep 5 &&
        npx prisma migrate deploy &&
        echo 'Migrations complete. Running seed...' &&
        npx prisma db seed &&
        echo 'Database setup complete!'
      "
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - prolific-network
    restart: "no"
    profiles:
      - setup

networks:
  prolific-network:
    driver: bridge
    name: prolific-network

volumes:
  postgres_data:
    name: prolific-postgres-data
  redis_data:
    name: prolific-redis-data
  frontend_node_modules:
    name: prolific-frontend-node-modules
  backend_node_modules:
    name: prolific-backend-node-modules
